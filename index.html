#include <WiFi.h>
#include <WebServer.h>

const char* ssid = "FC PKT";
const char* password = "@Binquynh76";

WebServer server(80);

void setup() {
  Serial.begin(115200);
  
  // K·∫øt n·ªëi Wi-Fi
  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\n‚úÖ ƒê√£ k·∫øt n·ªëi WiFi!");
  Serial.print("üì° ESP IP: ");
  Serial.println(WiFi.localIP());

  // Thi·∫øt l·∫≠p Web Server
  server.on("/", HTTP_GET, [](){
    String html = "<html><body><h1>ƒêi·ªÅu khi·ªÉn thi·∫øt b·ªã b·∫±ng Gi·ªçng N√≥i</h1><button onclick='startRecognition()'>B·∫Øt ƒë·∫ßu nh·∫≠n di·ªán gi·ªçng n√≥i</button><p id='output'></p><script>";
    html += "function startRecognition() { const recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition)();";
    html += "recognition.lang = 'vi-VN'; recognition.start();";
    html += "recognition.onresult = function(event) { document.getElementById('output').innerText = event.results[0][0].transcript;";
    html += "fetch('/voice?cmd=' + event.results[0][0].transcript).then(response => response.text()).then(data => console.log(data)); };";
    html += "}</script></body></html>";
    server.send(200, "text/html", html);
  });

  // X·ª≠ l√Ω l·ªánh gi·ªçng n√≥i
  server.on("/voice", HTTP_GET, handleVoiceCommand);
  
  server.begin();
}

void loop() {
  server.handleClient();
}

void handleVoiceCommand() {
  if (server.hasArg("cmd")) {
    String cmd = server.arg("cmd");
    // X·ª≠ l√Ω l·ªánh gi·ªçng n√≥i nh∆∞ trong m√£ tr∆∞·ªõc
    Serial.println("L·ªánh nh·∫≠n ƒë∆∞·ª£c: " + cmd);
    server.send(200, "text/plain", "L·ªánh gi·ªçng n√≥i ƒë√£ nh·∫≠n: " + cmd);
  } else {
    server.send(400, "text/plain", "Thi·∫øu tham s·ªë cmd");
  }
}
